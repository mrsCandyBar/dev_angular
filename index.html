<!doctype html>
<html ng-app="myApp">

  <head>

    <script src="build/js/angular.min.js"></script>
    <script src="components/tabs.js"></script>
    <script src="build/js/angular-route.min.js"></script>
    
    <script src="build/js/main.js"></script>
    <link rel="stylesheet" href="build/css/bootstrap.min.css">
  </head>

  <body>

    <!-- START -->
    <h2>Add Router</h2>
    <div ng-view></div>

    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-database.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyAHLGIuByAL6vrTfG7kbRtAwwf7kaCkt9k",
        authDomain: "starterproject-4e320.firebaseapp.com",
        databaseURL: "https://starterproject-4e320.firebaseio.com",
        projectId: "starterproject-4e320",
        storageBucket: "",
        messagingSenderId: "866187325341"
      };
      firebase.initializeApp(config);

      var database = firebase.database();
      

      // CRUD
      // WRITE TO DB
      function writeUserData(userId, username, email) {
        database.ref('users/' + userId).set({
          username,
          email
        });
      }

      // UPDATE DB
      function updateUserData(userId, username, email) {
        database.ref('users/' + userId).update({
          username,
          email
        });
      }

      // REMOVE FROM DB
      function removeUserData(userId) {
        database.ref('users/' + userId).remove();
      }

      // EG WRITE TO DB
      // writeUserData('ABC123','candice','candybar@gmail.com');

      // EG UPDATE DB
      // updateUserData('ABC123','candy','omw@gmail.com');

      // EG REMOVE FROM DB
      // removeUserData("ABC123")



      // LISTEN TO AUTHORIZATION STATE CHANGES
      function checkAuthState() {
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            console.log('logged >>>', user);

            // RETRIEVE DB ONCE ONLY
            /*database.ref('/users').once('value').then(function(snapshot) {
              console.log('once >>>', snapshot.val());
            });*/

            // RESPOND TO UPDATES AND INITIAL DATA LOAD
            database.ref('/users').on('value', function(snapshot) {
              console.log('updated >>> listen to db', snapshot.val());
              }, function(err) {
              console.log('denied >>>', err);
            });
            // ...
          } else {
            // User is signed out.
            // ...
            console.log('not >>>', user);

            // DEACTIVATE UPDATES TO DB
            database.ref('/users').off('value', function(snapshot) {
              console.log('updated >>> not listening anymore', snapshot.val());
              }, function(err) {
              console.log('denied >>>', err);
            });
          }
        });
      };


      // AUTHORIZE WITH EMAIL AND PASSWORD
      firebase.auth().signInWithEmailAndPassword(username, password).then((response) => {
        console.log('passed >>>', response);
        checkAuthState();

      }, (error) => {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log('failed >>>', errorMessage);
        // ...
      });


    </script>

  </body>

</html>